<div class="container py-4" style="max-width: 900px;">

  <!-- Header -->
  <div class="text-center mb-4">
    <div style="width:64px;height:64px;border-radius:16px;background:var(--cs-accent);display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;">
      <i class="bi bi-clipboard2-data text-white" style="font-size:1.75rem;"></i>
    </div>
    <h2>Security Assessment Intake</h2>
    <p class="text-muted">Provide details about your project so our security assessment team can prepare a tailored ITSG-33 control set. All fields marked <span class="text-danger">*</span> are required.</p>
  </div>

  {{#if success}}
  <div class="alert alert-success">
    <i class="bi bi-check-circle me-2"></i>
    <strong>Intake submitted successfully!</strong> Your submission reference is <strong>{{refCode}}</strong>. Our assessment team will review your submission and reach out to the project owner within 3–5 business days.
  </div>
  {{else}}

  <form method="POST" action="/intake" enctype="multipart/form-data" id="intakeForm">

    <!-- ─── AI Quick Start ─── -->
    <div class="form-section" style="border-left:3px solid #8b5cf6; background: linear-gradient(135deg, #faf5ff 0%, #f5f3ff 100%);">
      <div class="section-header" style="border-bottom-color:#e9d5ff;">
        <h4 class="section-title" style="color:#6d28d9;"><i class="bi bi-stars me-2"></i>AI-Assisted Intake <span class="badge bg-purple text-white" style="font-size:0.65rem; background:#8b5cf6 !important; vertical-align:middle;">BETA</span></h4>
        <p class="section-description">Upload a project document or describe your system in plain language and AI will suggest how to fill out this form.</p>
      </div>

      <div class="row g-3">
        <!-- Option A: Upload Document -->
        <div class="col-md-6">
          <div class="card h-100" style="border-color:#e9d5ff;">
            <div class="card-body">
              <h6 class="fw-bold mb-2"><i class="bi bi-file-earmark-arrow-up me-1 text-purple" style="color:#8b5cf6;"></i> Upload a Document</h6>
              <p class="text-muted small mb-2">Upload a design doc, SA, PIA, architecture diagram, or project charter (PDF, TXT, DOCX, PNG/JPG).</p>
              <input type="file" class="form-control form-control-sm" id="aiDocUpload" accept=".pdf,.txt,.md,.doc,.docx,.png,.jpg,.jpeg">
              <button type="button" class="btn btn-sm w-100 mt-2 text-white" style="background:#8b5cf6;" id="aiDocParseBtn" disabled onclick="aiParseDocument()">
                <i class="bi bi-stars me-1"></i>Analyze & Pre-fill
              </button>
            </div>
          </div>
        </div>

        <!-- Option B: Plain Language -->
        <div class="col-md-6">
          <div class="card h-100" style="border-color:#e9d5ff;">
            <div class="card-body">
              <h6 class="fw-bold mb-2"><i class="bi bi-chat-text me-1 text-purple" style="color:#8b5cf6;"></i> Describe Your Project</h6>
              <p class="text-muted small mb-2">Describe what your system does, who uses it, and what data it handles.</p>
              <textarea class="form-control form-control-sm" id="aiPlainDesc" rows="3" placeholder="e.g. We're building a portal for tax professionals to submit client returns. It connects to CRA mainframe and handles SIN, financial data. Hosted on Azure in Canada..."></textarea>
              <button type="button" class="btn btn-sm w-100 mt-2 text-white" style="background:#8b5cf6;" id="aiSuggestBtn" disabled onclick="aiSuggestFromDescription()">
                <i class="bi bi-stars me-1"></i>Get Suggestions
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI status message -->
      <div id="aiIntakeStatus" class="mt-2" style="display:none;"></div>
    </div>

    <!-- ─── Section 1: Project Information ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">1</span> Project Information</h4>
        <p class="section-description">Tell us about your project or system that requires a security assessment.</p>
      </div>

      <div class="mb-3">
        <label class="form-label" for="projectName">Project / System Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="projectName" name="projectName" required placeholder="e.g. HR Case Management Portal">
      </div>

      <div class="mb-3">
        <label class="form-label" for="projectDescription">Project Description <span class="text-danger">*</span></label>
        <textarea class="form-control" id="projectDescription" name="projectDescription" rows="4" required placeholder="Describe the purpose, scope, and key features of the system..."></textarea>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label" for="department">Department / Agency <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="department" name="department" required placeholder="e.g. Employment and Social Development Canada">
        </div>
        <div class="col-md-6">
          <label class="form-label" for="branch">Branch / Directorate</label>
          <input type="text" class="form-control" id="branch" name="branch" placeholder="e.g. Innovation, Information and Technology Branch">
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label class="form-label" for="targetDate">Target Go-Live Date</label>
          <input type="date" class="form-control" id="targetDate" name="targetDate">
        </div>
        <div class="col-md-4">
          <label class="form-label" for="userCount">Estimated User Count</label>
          <select class="form-select" id="userCount" name="userCount">
            <option value="">Select...</option>
            <option value="1-50">1 – 50</option>
            <option value="51-500">51 – 500</option>
            <option value="501-5000">501 – 5,000</option>
            <option value="5001+">5,000+</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="appType">Application Accessibility <span class="text-danger">*</span></label>
          <select class="form-select" id="appType" name="appType" required>
            <option value="">Select...</option>
            <option value="internal">Internal Only (GC network)</option>
            <option value="external">External / Public-Facing</option>
            <option value="hybrid">Hybrid (both internal & external)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ─── Section 2: Security Categorization ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">2</span> Security Categorization</h4>
        <p class="section-description">Categorize your system across three independent security dimensions per the <strong>TBS Directive on Security Management (Appendix J)</strong> and <strong>ITSG-33</strong>. The tool will automatically determine the applicable security control profile.</p>
      </div>

      <!-- ── 2A: Confidentiality ── -->
      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <h6 class="fw-bold mb-1"><i class="bi bi-shield-lock me-1"></i> Confidentiality Level <span class="text-danger">*</span></h6>
          <p class="text-muted small mb-2">What is the highest sensitivity of information the system will process, store, or transmit?</p>

          <select class="form-select cia-input" id="confidentialityLevel" name="confidentialityLevel" required>
            <option value="">Select confidentiality level...</option>
            <optgroup label="Non-National Interest (Protected)">
              <option value="unclassified">Unclassified — No injury expected from disclosure</option>
              <option value="protected-a">Protected A — Limited injury (e.g., internal memos, routine performance feedback)</option>
              <option value="protected-b" selected>Protected B — Serious injury (e.g., SIN, medical/tax/financial records, most PII)</option>
              <option value="protected-c">Protected C — Extremely grave injury (e.g., witness protection, informant IDs)</option>
            </optgroup>
            <optgroup label="National Interest (Classified)">
              <option value="confidential">Confidential — Limited injury to national interest</option>
              <option value="secret">Secret — Serious injury to national interest</option>
              <option value="top-secret">Top Secret — Exceptionally grave injury to national interest</option>
            </optgroup>
          </select>
          <div id="confHelp" class="form-text mt-1"></div>
        </div>
      </div>

      <!-- ── 2B: Integrity ── -->
      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <h6 class="fw-bold mb-1"><i class="bi bi-check2-square me-1"></i> Integrity Level <span class="text-danger">*</span></h6>
          <p class="text-muted small mb-2">What is the expected injury if data is modified, corrupted, or destroyed without authorization?</p>

          <select class="form-select cia-input" id="integrityLevel" name="integrityLevel" required>
            <option value="low">Low — Limited injury; minor data corruption tolerable with manual workarounds</option>
            <option value="medium" selected>Medium — Serious injury; data must be reliable, unauthorized changes significantly impact operations</option>
            <option value="high">High — Very grave injury; data accuracy is critical, corruption could endanger life/health/safety</option>
          </select>
        </div>
      </div>

      <!-- ── 2C: Availability ── -->
      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <h6 class="fw-bold mb-1"><i class="bi bi-clock-history me-1"></i> Availability Level <span class="text-danger">*</span></h6>
          <p class="text-muted small mb-2">What is the expected injury if the system is unavailable or disrupted?</p>

          <select class="form-select cia-input" id="availabilityLevel" name="availabilityLevel" required>
            <option value="low">Low — Extended outages (days) tolerable; alternative processes exist</option>
            <option value="medium" selected>Medium — Disruptions of hours could cause serious injury; system supports important operations</option>
            <option value="high">High — Even brief outages (minutes) cause grave injury; mission-critical or life/safety system</option>
          </select>
        </div>
      </div>

      <!-- ── 2D: High Value Asset ── -->
      <div class="card mb-3 border-0 bg-light">
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input cia-input" type="checkbox" id="isHVA" name="isHVA" value="1">
            <label class="form-check-label" for="isHVA">
              <strong><i class="bi bi-star me-1"></i> High Value Asset (HVA)</strong>
              <small class="d-block text-muted">Check if this system supports delivery of services at a national scale, is determined to be a significant solution handling sensitive information, or has been designated as a High Value Asset by your department. Adds the <strong>PBHVA overlay</strong> (137 additional controls).</small>
            </label>
          </div>
        </div>
      </div>

      <!-- ── Live Profile Preview ── -->
      <div id="profilePreview" class="alert alert-secondary mb-3" style="display:none;">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-cpu fs-5 me-2"></i>
          <div>
            <strong>Determined Security Profile:</strong>
            <span id="profileBadge" class="badge ms-2">—</span>
          </div>
        </div>
        <div id="profileName" class="fw-bold mb-1"></div>
        <div id="profileDesc" class="small mb-1"></div>
        <div id="profileControls" class="small text-muted"></div>
        <div id="profileTailoring" class="small mt-2" style="display:none;">
          <strong>Tailoring notes:</strong>
          <ul id="tailoringList" class="mb-0 mt-1 small"></ul>
        </div>
      </div>

      <hr class="my-3">

      <!-- ── 2E: PII Checklist ── -->
      <div class="mb-3">
        <label class="form-label fw-bold">Personal Information (PII) Checklist</label>
        <p class="text-muted small mb-2">Does your system collect, process, store, or transmit any of the following? Check all that apply.</p>

        <div class="row g-2">
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="name-address" id="pii-name">
              <label class="form-check-label" for="pii-name">
                <strong>Name, address, or contact info</strong>
                <small class="d-block text-muted">Full name, home/work address, phone, email</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="sin" id="pii-sin">
              <label class="form-check-label" for="pii-sin">
                <strong>Social Insurance Number (SIN)</strong>
                <small class="d-block text-muted">SIN or business number</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="financial" id="pii-financial">
              <label class="form-check-label" for="pii-financial">
                <strong>Financial information</strong>
                <small class="d-block text-muted">Bank accounts, tax records, pay info, CRA data</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="health" id="pii-health">
              <label class="form-check-label" for="pii-health">
                <strong>Health / Medical records</strong>
                <small class="d-block text-muted">Medical history, disability, mental health info</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="biometric" id="pii-bio">
              <label class="form-check-label" for="pii-bio">
                <strong>Biometric data</strong>
                <small class="d-block text-muted">Fingerprints, facial recognition, voice prints</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="employment" id="pii-emp">
              <label class="form-check-label" for="pii-emp">
                <strong>Employment / HR records</strong>
                <small class="d-block text-muted">Performance reviews, staffing actions, leave, grievances</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="immigration" id="pii-imm">
              <label class="form-check-label" for="pii-imm">
                <strong>Immigration / Citizenship data</strong>
                <small class="d-block text-muted">Visa applications, travel documents, citizenship status</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="law-enforcement" id="pii-law">
              <label class="form-check-label" for="pii-law">
                <strong>Law enforcement / Criminal records</strong>
                <small class="d-block text-muted">Case files, criminal history, investigations</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="indigenous" id="pii-indig">
              <label class="form-check-label" for="pii-indig">
                <strong>Indigenous / Treaty data</strong>
                <small class="d-block text-muted">Band membership, treaty info, land claims</small>
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check p-3 rounded border bg-white mb-1">
              <input class="form-check-input" type="checkbox" name="piiTypes" value="none" id="pii-none">
              <label class="form-check-label" for="pii-none">
                <strong>None of the above</strong>
                <small class="d-block text-muted">No personal information is collected or stored</small>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional data sensitivity questions -->
      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <label class="form-label">Does the system process data subject to <strong>ATIP</strong> requests?</label>
          <select class="form-select" name="atipSubject">
            <option value="">Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="unsure">Unsure</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Has a <strong>Privacy Impact Assessment (PIA)</strong> been completed?</label>
          <select class="form-select" name="piaCompleted">
            <option value="">Select...</option>
            <option value="yes">Yes — completed</option>
            <option value="in-progress">In progress</option>
            <option value="no">No — not started</option>
            <option value="not-required">Not required</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ─── Section 3: Hosting & Technology ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">3</span> Hosting & Technology Stack</h4>
        <p class="section-description">Where will the system be hosted, and which technologies are planned or already in use?</p>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label" for="hostingType">Primary Hosting Environment <span class="text-danger">*</span></label>
          <select class="form-select" id="hostingType" name="hostingType" required>
            <option value="">Select...</option>
            <option value="azure">Microsoft Azure</option>
            <option value="aws">Amazon Web Services (AWS)</option>
            <option value="gcp">Google Cloud Platform</option>
            <option value="ssc">SSC Data Centre (On-Premises)</option>
            <option value="hybrid">Hybrid (Cloud + On-Premises)</option>
            <option value="saas">SaaS (Third-Party Hosted)</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label" for="hostingRegion">Data Residency</label>
          <select class="form-select" id="hostingRegion" name="hostingRegion">
            <option value="">Select...</option>
            <option value="canada-only" selected>Canada Only</option>
            <option value="canada-primary">Canada Primary (some US failover)</option>
            <option value="north-america">North America</option>
            <option value="global">Global</option>
            <option value="unsure">Unsure</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Technology Stack</label>
        <p class="text-muted small mb-2">Check all technologies that are part of this implementation.</p>

        <h6 class="text-muted small text-uppercase mt-3 mb-2">Identity & Access</h6>
        <div class="row g-2">
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="entra-id" id="tech-entra"><label class="form-check-label" for="tech-entra">Microsoft Entra ID (Azure AD)</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="active-directory" id="tech-ad"><label class="form-check-label" for="tech-ad">Active Directory (On-Prem)</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="mfa" id="tech-mfa"><label class="form-check-label" for="tech-mfa">Multi-Factor Authentication</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="pim" id="tech-pim"><label class="form-check-label" for="tech-pim">Privileged Identity Management</label></div></div>
        </div>

        <h6 class="text-muted small text-uppercase mt-3 mb-2">Cloud & Infrastructure</h6>
        <div class="row g-2">
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="azure" id="tech-azure"><label class="form-check-label" for="tech-azure">Microsoft Azure</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="aws" id="tech-aws"><label class="form-check-label" for="tech-aws">Amazon Web Services</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="gcp" id="tech-gcp"><label class="form-check-label" for="tech-gcp">Google Cloud Platform</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="ssc-dc" id="tech-ssc"><label class="form-check-label" for="tech-ssc">SSC Data Centre</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="gc-network" id="tech-gcnet"><label class="form-check-label" for="tech-gcnet">GC Network (GCNet)</label></div></div>
        </div>

        <h6 class="text-muted small text-uppercase mt-3 mb-2">Security & Monitoring</h6>
        <div class="row g-2">
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="siem-sentinel" id="tech-sentinel"><label class="form-check-label" for="tech-sentinel">Microsoft Sentinel (SIEM)</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="siem-splunk" id="tech-splunk"><label class="form-check-label" for="tech-splunk">Splunk (SIEM)</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="defender" id="tech-defender"><label class="form-check-label" for="tech-defender">Microsoft Defender</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="crowdstrike" id="tech-cs"><label class="form-check-label" for="tech-cs">CrowdStrike Falcon</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="gc-cse" id="tech-cse"><label class="form-check-label" for="tech-cse">CSE / CCCS Services</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="waf" id="tech-waf"><label class="form-check-label" for="tech-waf">Web Application Firewall</label></div></div>
        </div>

        <h6 class="text-muted small text-uppercase mt-3 mb-2">DevOps, Encryption & Management</h6>
        <div class="row g-2">
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="azure-devops" id="tech-ado"><label class="form-check-label" for="tech-ado">Azure DevOps</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="github" id="tech-gh"><label class="form-check-label" for="tech-gh">GitHub Enterprise</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="intune" id="tech-intune"><label class="form-check-label" for="tech-intune">Microsoft Intune (MDM)</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="key-vault" id="tech-kv"><label class="form-check-label" for="tech-kv">Azure Key Vault</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="aws-kms" id="tech-kms"><label class="form-check-label" for="tech-kms">AWS KMS</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="ssl-tls" id="tech-tls"><label class="form-check-label" for="tech-tls">TLS 1.2 / 1.3</label></div></div>
          <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" name="technologies" value="backup-azure" id="tech-backup"><label class="form-check-label" for="tech-backup">Azure Backup</label></div></div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label" for="otherTech">Other Technologies / Notes</label>
        <textarea class="form-control" id="otherTech" name="otherTech" rows="2" placeholder="List any technologies not covered above (e.g. Oracle DB, SAP, Dynamics 365, Power Platform, etc.)"></textarea>
      </div>
    </div>

    <!-- ─── Section 4: System Architecture & Integrations ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">4</span> Architecture & Integrations</h4>
        <p class="section-description">Help us understand how the system connects to other systems and the internet.</p>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label">Does the system expose or consume <strong>APIs</strong>?</label>
          <select class="form-select" name="hasAPIs">
            <option value="">Select...</option>
            <option value="exposes">Yes — exposes APIs</option>
            <option value="consumes">Yes — consumes external APIs</option>
            <option value="both">Yes — both</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Does the system connect to other <strong>GC systems</strong>?</label>
          <select class="form-select" name="gcInterconnections">
            <option value="">Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="planned">Planned</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label" for="interconnections">List Known Interconnections / Integrations</label>
        <textarea class="form-control" id="interconnections" name="interconnections" rows="3" placeholder="e.g. GCcase (via API), SAP (file transfer), GCDOCS (document storage), Canada.ca (public portal)..."></textarea>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Will the system support <strong>mobile / BYOD</strong> access?</label>
          <select class="form-select" name="mobileAccess">
            <option value="">Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
            <option value="planned">Planned for future</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Will <strong>external users</strong> (non-GC) access the system?</label>
          <select class="form-select" name="externalUsers">
            <option value="">Select...</option>
            <option value="yes">Yes — public or partner access</option>
            <option value="no">No — GC employees only</option>
            <option value="contractors">Contractors / consultants only</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ─── Section 5: Existing Security Posture ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">5</span> Existing Security Posture</h4>
        <p class="section-description">Let us know what security work has already been completed.</p>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Completed Security Activities</label>
        <p class="text-muted small mb-2">Check all that have been completed or are in progress.</p>
        <div class="row g-2">
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="tra" id="act-tra"><label class="form-check-label" for="act-tra"><strong>Threat & Risk Assessment (TRA)</strong></label></div></div>
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="pia" id="act-pia"><label class="form-check-label" for="act-pia"><strong>Privacy Impact Assessment (PIA)</strong></label></div></div>
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="ssp" id="act-ssp"><label class="form-check-label" for="act-ssp"><strong>System Security Plan (SSP)</strong></label></div></div>
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="vapt" id="act-vapt"><label class="form-check-label" for="act-vapt"><strong>Vulnerability Assessment / Pen Test</strong></label></div></div>
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="network-diagram" id="act-nd"><label class="form-check-label" for="act-nd"><strong>Network / Architecture Diagram</strong></label></div></div>
          <div class="col-md-6"><div class="form-check p-3 rounded border bg-white"><input class="form-check-input" type="checkbox" name="completedActivities" value="previous-sa" id="act-sa"><label class="form-check-label" for="act-sa"><strong>Previous SA&A / ATO</strong></label></div></div>
        </div>
      </div>
    </div>

    <!-- ─── Section 6: Key Contacts ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">6</span> Key Contacts</h4>
        <p class="section-description">Provide contact details for the people involved in this assessment.</p>
      </div>

      <h6 class="fw-bold mb-2">Project Owner / Submitter <span class="text-danger">*</span></h6>
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="ownerName" required placeholder="Full name">
        </div>
        <div class="col-md-4">
          <input type="email" class="form-control" name="ownerEmail" required placeholder="Email address">
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" name="ownerTitle" placeholder="Title / Role">
        </div>
      </div>

      <h6 class="fw-bold mb-2">Technical Lead</h6>
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="techLeadName" placeholder="Full name">
        </div>
        <div class="col-md-4">
          <input type="email" class="form-control" name="techLeadEmail" placeholder="Email address">
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" name="techLeadTitle" placeholder="Title / Role">
        </div>
      </div>

      <h6 class="fw-bold mb-2">Authorizing Official (DG / Director)</h6>
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="authorityName" placeholder="Full name">
        </div>
        <div class="col-md-4">
          <input type="email" class="form-control" name="authorityEmail" placeholder="Email address">
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" name="authorityTitle" placeholder="Title / Role">
        </div>
      </div>
    </div>

    <!-- ─── Section 7: Attachments ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">7</span> Supporting Documents</h4>
        <p class="section-description">Upload any existing documentation that will help our assessment team. Accepted formats: PDF, Word, Excel, PowerPoint, images, Visio. Max 25 MB per file.</p>
      </div>

      <div class="mb-3">
        <label class="form-label">Attachments</label>
        <input type="file" class="form-control" name="attachments" id="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.pptx,.ppt,.png,.jpg,.jpeg,.gif,.vsdx,.vsd,.txt,.md,.csv">
        <small class="text-muted">You can select multiple files. Examples: architecture diagrams, TRA reports, SSP documents, network diagrams, previous ATO letters.</small>
      </div>

      <div id="fileList" class="mb-3" style="display:none;">
        <label class="form-label fw-bold small text-muted">Selected files:</label>
        <div id="fileListContent"></div>
      </div>
    </div>

    <!-- ─── Section 8: Additional Context ─── -->
    <div class="form-section">
      <div class="section-header">
        <h4 class="section-title"><span class="section-number">8</span> Additional Context</h4>
        <p class="section-description">Any other information that would help us prepare your assessment.</p>
      </div>

      <div class="mb-3">
        <label class="form-label" for="additionalNotes">Notes / Questions / Special Considerations</label>
        <textarea class="form-control" id="additionalNotes" name="additionalNotes" rows="4" placeholder="e.g. tight deadline, need iATO first, migrating from legacy system, specific compliance requirements..."></textarea>
      </div>
    </div>

    <!-- Submit -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-5">
      <a href="/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i> Back</a>
      <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
        <i class="bi bi-send me-2"></i>Submit Intake
      </button>
    </div>
  </form>

  <script>
    // File list preview
    document.getElementById('attachments').addEventListener('change', function() {
      const list = document.getElementById('fileList');
      const content = document.getElementById('fileListContent');
      if (this.files.length > 0) {
        list.style.display = 'block';
        content.innerHTML = Array.from(this.files).map(f =>
          '<div class="d-flex align-items-center gap-2 py-1"><i class="bi bi-file-earmark text-muted"></i><span class="small">' + f.name + '</span><span class="badge bg-light text-muted">' + (f.size / 1024 / 1024).toFixed(2) + ' MB</span></div>'
        ).join('');
      } else {
        list.style.display = 'none';
      }
    });

    // "None of the above" exclusive toggle
    document.getElementById('pii-none').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('input[name="piiTypes"]:not(#pii-none)').forEach(cb => cb.checked = false);
      }
    });
    document.querySelectorAll('input[name="piiTypes"]:not(#pii-none)').forEach(cb => {
      cb.addEventListener('change', function() {
        if (this.checked) document.getElementById('pii-none').checked = false;
      });
    });

    // Submit protection
    document.getElementById('intakeForm').addEventListener('submit', function() {
      var btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    });

    // ── Live Profile Determination Preview ──
    const PROFILES = {
      NONE: { name: 'No SA&A Required — GC Web Guidance Only', color: 'secondary', controls: '~48 checklist items' },
      CCCS_LOW: { name: 'CCCS Low Cloud Profile (PA/L/L)', color: 'info', controls: '~220 controls' },
      PBMM: { name: 'ITSG-33 Profile 1 — Protected B / Medium / Medium (PBMM)', color: 'warning', controls: '~310 controls + enhancements' },
      PBMM_HVA: { name: 'PBMM + High Value Asset Overlay', color: 'warning', controls: '~380 controls + enhancements' },
      PB_HIGH: { name: 'Protected B / High I/A (Tailored from PBMM)', color: 'danger', controls: '~350+ controls (tailored)' },
      PC_BASELINE: { name: 'Protected C Baseline (Tailored from PBMM)', color: 'danger', controls: '~380+ controls (tailored)' },
      SECRET_MM: { name: 'ITSG-33 Profile 3 — Secret / Medium / Medium', color: 'dark', controls: '~380 controls + enhancements' },
      CLASSIFIED_HIGH: { name: 'Classified — Custom Profile (CSE engagement required)', color: 'dark', controls: 'Custom' }
    };

    function determineProfileClient() {
      const conf = document.getElementById('confidentialityLevel').value;
      const integ = document.getElementById('integrityLevel').value;
      const avail = document.getElementById('availabilityLevel').value;
      const hva = document.getElementById('isHVA').checked;
      const piiChecked = document.querySelectorAll('input[name="piiTypes"]:checked:not(#pii-none)').length > 0;

      if (!conf) return null;

      let profileId, reason, notes = [];
      const national = ['confidential', 'secret', 'top-secret'].includes(conf);

      if (national) {
        if (conf === 'secret' && integ === 'medium' && avail === 'medium') {
          profileId = 'SECRET_MM'; reason = 'Secret / Medium / Medium → ITSG-33 Profile 3';
        } else {
          profileId = 'CLASSIFIED_HIGH'; reason = conf.replace('-', ' ') + ' classification requires CSE/CCCS engagement';
          notes.push('No published CSE profile — department must develop custom profile with CSE.');
          if (conf === 'top-secret') notes.push('Top Secret requires dedicated infrastructure with enhanced physical, personnel, and TEMPEST controls.');
        }
      } else if (conf === 'protected-c') {
        profileId = 'PC_BASELINE'; reason = 'Protected C requires tailored profile above PBMM';
        notes.push('Start from PBMM baseline and tailor upward for enhanced confidentiality.');
      } else if (conf === 'protected-b') {
        if (integ === 'high' || avail === 'high') {
          profileId = 'PB_HIGH'; reason = 'Protected B with high ' + (integ === 'high' ? 'integrity' : '') + (integ === 'high' && avail === 'high' ? ' and ' : '') + (avail === 'high' ? 'availability' : '');
          notes.push('Start from PBMM and tailor upward.');
        } else if (hva) {
          profileId = 'PBMM_HVA'; reason = 'Protected B / Medium / Medium + HVA designation';
          notes.push('PBHVA overlay adds 69 controls for enhanced integrity and availability.');
        } else {
          profileId = 'PBMM'; reason = 'Protected B / Medium / Medium — standard PBMM';
        }
      } else if (conf === 'protected-a') {
        if (integ === 'low' && avail === 'low') {
          profileId = 'CCCS_LOW'; reason = 'Protected A / Low / Low — CCCS Low';
        } else {
          profileId = 'PBMM'; reason = 'Protected A with medium+ I/A elevates to PBMM';
          notes.push('Higher I/A dimensions drive profile selection upward.');
        }
      } else {
        // Unclassified
        if (piiChecked) {
          profileId = (integ !== 'low' || avail !== 'low') ? 'PBMM' : 'CCCS_LOW';
          reason = 'Unclassified with PII — elevated to ' + (profileId === 'PBMM' ? 'PBMM' : 'CCCS Low');
        } else if (integ !== 'low' || avail !== 'low') {
          profileId = 'CCCS_LOW'; reason = 'Unclassified with medium+ I/A';
        } else {
          profileId = 'NONE'; reason = 'Unclassified / low impact / no PII';
        }
      }

      return { profileId, reason, notes };
    }

    function updateProfilePreview() {
      const result = determineProfileClient();
      const preview = document.getElementById('profilePreview');
      if (!result) { preview.style.display = 'none'; return; }

      const p = PROFILES[result.profileId];
      preview.style.display = 'block';
      preview.className = 'alert alert-' + (p.color === 'dark' ? 'dark' : p.color === 'danger' ? 'danger' : p.color === 'warning' ? 'warning' : p.color === 'info' ? 'info' : 'secondary') + ' mb-3';
      document.getElementById('profileBadge').className = 'badge bg-' + p.color + ' ms-2';
      document.getElementById('profileBadge').textContent = result.profileId.replace(/_/g, ' ');
      document.getElementById('profileName').textContent = p.name;
      document.getElementById('profileDesc').textContent = result.reason;
      document.getElementById('profileControls').textContent = 'Baseline: ' + p.controls;

      const tailDiv = document.getElementById('profileTailoring');
      const tailList = document.getElementById('tailoringList');
      if (result.notes.length > 0) {
        tailDiv.style.display = 'block';
        tailList.innerHTML = result.notes.map(n => '<li>' + n + '</li>').join('');
      } else {
        tailDiv.style.display = 'none';
      }
    }

    // Bind change events
    document.querySelectorAll('.cia-input').forEach(el => el.addEventListener('change', updateProfilePreview));
    document.querySelectorAll('input[name="piiTypes"]').forEach(el => el.addEventListener('change', updateProfilePreview));
    // Initial render
    updateProfilePreview();
  </script>

  {{> ai-panel }}

  <script>
  // ═══════════════════════════════════════════════════════════════════════════
  // INTAKE AI INTEGRATION
  // ═══════════════════════════════════════════════════════════════════════════

  // Enable/disable AI buttons based on input
  document.getElementById('aiDocUpload').addEventListener('change', function() {
    document.getElementById('aiDocParseBtn').disabled = !this.files.length;
  });
  document.getElementById('aiPlainDesc').addEventListener('input', function() {
    document.getElementById('aiSuggestBtn').disabled = this.value.trim().length < 20;
  });

  function aiShowStatus(msg, type = 'info') {
    const el = document.getElementById('aiIntakeStatus');
    el.style.display = 'block';
    el.className = 'mt-2 alert alert-' + type + ' small py-2';
    el.innerHTML = msg;
  }

  function aiHideStatus() {
    document.getElementById('aiIntakeStatus').style.display = 'none';
  }

  // Field mapping from AI response to form elements
  const AI_FIELD_MAP = {
    // Section 1: Project Information
    projectName: { type: 'input', id: 'projectName' },
    projectDescription: { type: 'textarea', id: 'projectDescription' },
    department: { type: 'input', id: 'department' },
    branch: { type: 'input', id: 'branch' },
    userCount: { type: 'select', id: 'userCount' },
    appType: { type: 'select', id: 'appType' },
    // Section 2: Security Categorization
    confidentialityLevel: { type: 'select', id: 'confidentialityLevel' },
    integrityLevel: { type: 'select', id: 'integrityLevel' },
    availabilityLevel: { type: 'select', id: 'availabilityLevel' },
    isHVA: { type: 'checkbox', id: 'hvaCheck' },
    atipSubject: { type: 'selectByName', name: 'atipSubject' },
    piaCompleted: { type: 'selectByName', name: 'piaCompleted' },
    // Section 3: Hosting & Technology
    hostingType: { type: 'select', id: 'hostingType' },
    hostingRegion: { type: 'select', id: 'hostingRegion' },
    otherTech: { type: 'textarea', id: 'otherTech' },
    // Section 4: Architecture & Integrations
    hasAPIs: { type: 'selectByName', name: 'hasAPIs' },
    gcInterconnections: { type: 'selectByName', name: 'gcInterconnections' },
    interconnections: { type: 'textarea', id: 'interconnections' },
    mobileAccess: { type: 'selectByName', name: 'mobileAccess' },
    externalUsers: { type: 'selectByName', name: 'externalUsers' }
  };

  function aiApplyField(key, value) {
    if (value === null || value === undefined) return;
    const map = AI_FIELD_MAP[key];
    if (!map) return;

    if (map.type === 'input' || map.type === 'textarea') {
      const el = document.getElementById(map.id);
      if (el) { el.value = value; el.classList.add('ai-highlighted'); }
    } else if (map.type === 'select') {
      const el = document.getElementById(map.id);
      if (el) {
        for (let opt of el.options) {
          if (opt.value === value) { el.value = value; el.classList.add('ai-highlighted'); break; }
        }
      }
    } else if (map.type === 'selectByName') {
      const el = document.querySelector('select[name="' + map.name + '"]');
      if (el) {
        for (let opt of el.options) {
          if (opt.value === value) { el.value = value; el.classList.add('ai-highlighted'); break; }
        }
      }
    } else if (map.type === 'checkbox') {
      const el = document.getElementById(map.id);
      if (el) { el.checked = !!value; el.classList.add('ai-highlighted'); }
    }
  }

  function aiApplyPiiTypes(types) {
    if (!types || !types.length) return;
    // Uncheck "none" first
    const noneEl = document.getElementById('pii-none');
    if (noneEl) noneEl.checked = false;
    types.forEach(t => {
      if (t === 'none') {
        const nEl = document.getElementById('pii-none');
        if (nEl) { nEl.checked = true; nEl.classList.add('ai-highlighted'); }
        return;
      }
      const el = document.querySelector('input[name="piiTypes"][value="' + t + '"]');
      if (el) { el.checked = true; el.classList.add('ai-highlighted'); }
    });
  }

  function aiApplyTechnologies(techs) {
    if (!techs || !techs.length) return;
    techs.forEach(t => {
      const el = document.querySelector('input[name="technologies"][value="' + t + '"]');
      if (el) { el.checked = true; el.classList.add('ai-highlighted'); }
    });
  }

  function aiApplyCompletedActivities(activities) {
    if (!activities || !activities.length) return;
    activities.forEach(a => {
      const el = document.querySelector('input[name="completedActivities"][value="' + a + '"]');
      if (el) { el.checked = true; el.classList.add('ai-highlighted'); }
    });
  }

  function aiApplyAllFields(fields) {
    let applied = 0;
    // Apply simple fields
    Object.keys(AI_FIELD_MAP).forEach(key => {
      if (fields[key] !== null && fields[key] !== undefined) {
        aiApplyField(key, fields[key]);
        applied++;
      }
    });
    // Apply array fields
    if (fields.piiTypes) { aiApplyPiiTypes(fields.piiTypes); applied++; }
    if (fields.technologies) { aiApplyTechnologies(fields.technologies); applied++; }
    if (fields.completedActivities) { aiApplyCompletedActivities(fields.completedActivities); applied++; }
    // Trigger profile recalculation
    updateProfilePreview();
    return applied;
  }

  // Show results in AI panel with accept/reject per field
  function aiShowResults(fields, reasoning) {
    const labelMap = {
      // Section 1
      projectName: 'Project Name', projectDescription: 'Description', department: 'Department',
      branch: 'Branch', userCount: 'User Count', appType: 'App Type',
      // Section 2
      confidentialityLevel: 'Confidentiality', integrityLevel: 'Integrity',
      availabilityLevel: 'Availability', isHVA: 'High Value Asset',
      piiTypes: 'PII Types', atipSubject: 'ATIP Subject', piaCompleted: 'PIA Status',
      // Section 3
      hostingType: 'Hosting Environment', hostingRegion: 'Data Residency',
      technologies: 'Technologies', otherTech: 'Other Technologies',
      // Section 4
      hasAPIs: 'APIs', gcInterconnections: 'GC Interconnections',
      interconnections: 'Interconnections', mobileAccess: 'Mobile/BYOD', externalUsers: 'External Users',
      // Section 5
      completedActivities: 'Completed Security Activities'
    };

    // Section grouping for organized display
    const sectionGroups = [
      { title: '1 — Project Information', keys: ['projectName','projectDescription','department','branch','userCount','appType'] },
      { title: '2 — Security Categorization', keys: ['confidentialityLevel','integrityLevel','availabilityLevel','isHVA','piiTypes','atipSubject','piaCompleted'] },
      { title: '3 — Hosting & Technology', keys: ['hostingType','hostingRegion','technologies','otherTech'] },
      { title: '4 — Architecture & Integrations', keys: ['hasAPIs','gcInterconnections','interconnections','mobileAccess','externalUsers'] },
      { title: '5 — Security Posture', keys: ['completedActivities'] }
    ];

    let cardsHtml = '';
    let cardIndex = 0;
    const allFieldKeys = Object.keys(fields).filter(k => k !== 'reasoning' && fields[k] !== null && fields[k] !== undefined);

    sectionGroups.forEach(section => {
      const sectionKeys = section.keys.filter(k => allFieldKeys.includes(k));
      if (!sectionKeys.length) return;

      cardsHtml += `<div class="ai-section-title mt-3">${section.title}</div>`;

      sectionKeys.forEach(key => {
        const val = fields[key];
        const displayVal = Array.isArray(val) ? val.join(', ') : (typeof val === 'boolean' ? (val ? 'Yes' : 'No') : String(val));
        const i = cardIndex++;
        cardsHtml += `
        <div class="ai-card" id="ai-intake-card-${i}">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold small">${labelMap[key] || key}</div>
              <div class="small text-muted" style="word-break:break-word;">${displayVal.substring(0, 200)}${displayVal.length > 200 ? '...' : ''}</div>
            </div>
            <div class="d-flex gap-1 flex-shrink-0 ms-2">
              <button class="ai-accept-btn" onclick="aiAcceptSingle('${key}', window._aiFields); this.closest('.ai-card').classList.add('accepted');">
                <i class="bi bi-check2"></i>
              </button>
              <button class="ai-reject-btn" onclick="this.closest('.ai-card').classList.add('rejected');">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>`;
      });
    });

    AIPanel.open({
      title: 'AI Suggestions',
      subtitle: 'Review and accept individual fields',
      body: `
        ${reasoning ? `<div class="ai-section"><div class="ai-section-title">AI Reasoning</div><div class="small text-muted p-2 rounded" style="background:#f5f3ff;">${reasoning}</div></div>` : ''}
        <div class="ai-section">
          <div class="ai-section-title">Suggested Fields (${allFieldKeys.length})</div>
          ${cardsHtml}
        </div>`,
      footer: `
        <div class="d-flex gap-2">
          <button class="btn btn-sm flex-fill text-white" style="background:#8b5cf6;" onclick="aiAcceptAll()"><i class="bi bi-check-all me-1"></i>Accept All</button>
          <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="AIPanel.close()">Close</button>
        </div>`
    });
  }

  function aiAcceptSingle(key, fields) {
    if (key === 'piiTypes') { aiApplyPiiTypes(fields[key]); }
    else if (key === 'technologies') { aiApplyTechnologies(fields[key]); }
    else if (key === 'completedActivities') { aiApplyCompletedActivities(fields[key]); }
    else { aiApplyField(key, fields[key]); }
    updateProfilePreview();
  }

  function aiAcceptAll() {
    if (window._aiFields) {
      const n = aiApplyAllFields(window._aiFields);
      aiShowStatus('<i class="bi bi-check-circle me-1"></i>Applied ' + n + ' AI suggestions. Review the form and adjust as needed.', 'success');
      AIPanel.close();
    }
  }

  // ── Upload document and parse ──────────────────────────────────────────────
  async function aiParseDocument() {
    const file = document.getElementById('aiDocUpload').files[0];
    if (!file) return;

    aiShowStatus('<i class="bi bi-hourglass-split me-1"></i>Uploading and analyzing document... this may take 10-15 seconds.', 'info');
    AIPanel.open({ title: 'Analyzing Document', subtitle: file.name });
    AIPanel.showLoading('Reading and analyzing your document...');

    try {
      const formData = new FormData();
      formData.append('document', file);
      const resp = await fetch('/api/ai/parse-document', { method: 'POST', body: formData });
      const data = await resp.json();

      if (!data.success) throw new Error(data.error || 'Analysis failed');

      window._aiFields = data.fields;
      aiHideStatus();
      aiShowResults(data.fields, data.fields.reasoning);
    } catch (err) {
      aiShowStatus('<i class="bi bi-exclamation-triangle me-1"></i>' + err.message, 'danger');
      AIPanel.showError(err.message);
    }
  }

  // ── Suggest from plain language ────────────────────────────────────────────
  async function aiSuggestFromDescription() {
    const desc = document.getElementById('aiPlainDesc').value.trim();
    if (desc.length < 20) return;

    aiShowStatus('<i class="bi bi-hourglass-split me-1"></i>Analyzing your description...', 'info');
    AIPanel.open({ title: 'Analyzing Description', subtitle: 'Plain language intake' });
    AIPanel.showLoading('Determining security categorization...');

    try {
      const resp = await fetch('/api/ai/suggest-from-description', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc })
      });
      const data = await resp.json();

      if (!data.success) throw new Error(data.error || 'Suggestion failed');

      window._aiFields = data.suggestions;
      aiHideStatus();
      aiShowResults(data.suggestions, data.suggestions.reasoning);
    } catch (err) {
      aiShowStatus('<i class="bi bi-exclamation-triangle me-1"></i>' + err.message, 'danger');
      AIPanel.showError(err.message);
    }
  }
  </script>

  <style>
    .ai-highlighted {
      box-shadow: 0 0 0 2px #c4b5fd !important;
      transition: box-shadow 0.3s;
    }
    .ai-highlighted:focus { box-shadow: 0 0 0 3px #8b5cf6 !important; }
  </style>

  {{/if}}
</div>
