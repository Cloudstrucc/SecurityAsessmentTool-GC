{{!-- 
  AI Assistant Slide-Out Panel
  Include this partial in any page that needs AI assistance.
  Requires: Bootstrap 5, Bootstrap Icons
  
  Usage:
    {{> ai-panel }}
    Then call: AIPanel.open({ title, body }) or use the helper functions
--}}

<!-- Floating AI trigger button -->
<button id="aiTriggerBtn" class="ai-trigger-btn" onclick="AIPanel.toggle()" title="AI Assistant">
  <i class="bi bi-stars"></i>
</button>

<!-- Slide-out panel backdrop -->
<div id="aiBackdrop" class="ai-backdrop" onclick="AIPanel.close()"></div>

<!-- Slide-out panel -->
<div id="aiPanel" class="ai-panel">
  <div class="ai-panel-header">
    <div class="d-flex align-items-center gap-2">
      <div class="ai-panel-icon"><i class="bi bi-stars"></i></div>
      <div>
        <h5 class="mb-0" id="aiPanelTitle">AI Assistant</h5>
        <small class="text-muted" id="aiPanelSubtitle">Powered by Claude</small>
      </div>
    </div>
    <button class="btn btn-sm btn-link text-muted" onclick="AIPanel.close()" style="font-size:1.25rem;">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="ai-panel-body" id="aiPanelBody">
    <!-- Dynamic content goes here -->
    <div class="text-center text-muted py-5">
      <i class="bi bi-stars" style="font-size:3rem;opacity:0.2;"></i>
      <p class="mt-3">Select an AI action to get started</p>
    </div>
  </div>

  <div class="ai-panel-footer" id="aiPanelFooter" style="display:none;">
    <!-- Dynamic footer actions -->
  </div>
</div>

<style>
  /* ── Floating trigger button ── */
  .ai-trigger-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1040;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
    color: #fff;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(99,102,241,0.4);
    cursor: pointer;
    transition: all 0.3s ease;
    animation: ai-pulse 3s ease-in-out infinite;
  }
  .ai-trigger-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 28px rgba(99,102,241,0.5);
  }
  @keyframes ai-pulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(99,102,241,0.4); }
    50% { box-shadow: 0 4px 30px rgba(139,92,246,0.6); }
  }

  /* ── Backdrop ── */
  .ai-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1049;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
    transition: opacity 0.3s;
  }
  .ai-backdrop.show { display: block; }

  /* ── Panel ── */
  .ai-panel {
    position: fixed;
    top: 0;
    right: -520px;
    width: 500px;
    max-width: 90vw;
    height: 100vh;
    z-index: 1050;
    background: #fff;
    box-shadow: -8px 0 30px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .ai-panel.open { right: 0; }

  .ai-panel-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8f7ff 0%, #f0f0ff 100%);
  }
  .ai-panel-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
  }

  .ai-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
  }

  .ai-panel-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }

  /* ── Reusable inner components ── */
  .ai-section { margin-bottom: 1.25rem; }
  .ai-section-title {
    font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: #6366f1; margin-bottom: 0.5rem;
  }

  .ai-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.875rem;
    margin-bottom: 0.625rem;
    transition: all 0.2s;
  }
  .ai-card:hover { border-color: #c7d2fe; background: #f5f3ff; }
  .ai-card.accepted { border-color: #86efac; background: #f0fdf4; }
  .ai-card.rejected { opacity: 0.5; border-color: #fecaca; }

  .ai-accept-btn, .ai-reject-btn {
    border: none; border-radius: 6px; padding: 0.25rem 0.625rem;
    font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
  }
  .ai-accept-btn { background: #dcfce7; color: #166534; }
  .ai-accept-btn:hover { background: #bbf7d0; }
  .ai-reject-btn { background: #fee2e2; color: #991b1b; }
  .ai-reject-btn:hover { background: #fecaca; }

  .ai-loading {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 3rem 1rem; color: #6366f1;
  }
  .ai-loading .spinner {
    width: 40px; height: 40px; border: 3px solid #e0e7ff; border-top-color: #6366f1;
    border-radius: 50%; animation: ai-spin 0.8s linear infinite;
  }
  @keyframes ai-spin { to { transform: rotate(360deg); } }

  .ai-badge {
    display: inline-block; padding: 0.15rem 0.5rem; border-radius: 20px;
    font-size: 0.75rem; font-weight: 600;
  }
  .ai-badge-low { background: #dcfce7; color: #166534; }
  .ai-badge-medium { background: #fef3c7; color: #92400e; }
  .ai-badge-high { background: #fee2e2; color: #991b1b; }
  .ai-badge-critical { background: #991b1b; color: #fff; }

  .ai-question-item {
    background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px;
    padding: 0.75rem; margin-bottom: 0.5rem;
  }

  .ai-score {
    display: inline-flex; align-items: center; justify-content: center;
    width: 40px; height: 40px; border-radius: 50%; font-size: 1.1rem; font-weight: 700;
  }
</style>

<script>
// ═══════════════════════════════════════════════════════════════════════════════
// AI Panel Controller
// ═══════════════════════════════════════════════════════════════════════════════
const AIPanel = {
  panel: null,
  backdrop: null,
  body: null,
  footer: null,
  isOpen: false,

  init() {
    this.panel = document.getElementById('aiPanel');
    this.backdrop = document.getElementById('aiBackdrop');
    this.body = document.getElementById('aiPanelBody');
    this.footer = document.getElementById('aiPanelFooter');
    // Check AI availability
    fetch('/api/ai/status').then(r => r.json()).then(d => {
      if (!d.configured) {
        document.getElementById('aiTriggerBtn').style.opacity = '0.4';
        document.getElementById('aiTriggerBtn').title = 'AI not configured — set ANTHROPIC_API_KEY';
      }
    }).catch(() => {});
  },

  open(opts = {}) {
    if (opts.title) document.getElementById('aiPanelTitle').textContent = opts.title;
    if (opts.subtitle) document.getElementById('aiPanelSubtitle').textContent = opts.subtitle;
    if (opts.body) this.body.innerHTML = opts.body;
    if (opts.footer) { this.footer.innerHTML = opts.footer; this.footer.style.display = ''; }
    else { this.footer.style.display = 'none'; }
    this.panel.classList.add('open');
    this.backdrop.classList.add('show');
    this.isOpen = true;
  },

  close() {
    this.panel.classList.remove('open');
    this.backdrop.classList.remove('show');
    this.isOpen = false;
  },

  toggle() {
    this.isOpen ? this.close() : this.open();
  },

  showLoading(message = 'Analyzing...') {
    this.body.innerHTML = `
      <div class="ai-loading">
        <div class="spinner"></div>
        <p class="mt-3 mb-0">${message}</p>
        <small class="text-muted mt-1">This may take a few seconds</small>
      </div>`;
    this.footer.style.display = 'none';
  },

  showError(message) {
    this.body.innerHTML = `
      <div class="text-center py-4">
        <i class="bi bi-exclamation-triangle text-warning" style="font-size:2.5rem;"></i>
        <p class="mt-3 mb-1 fw-bold">Something went wrong</p>
        <p class="text-muted small">${message}</p>
        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="AIPanel.close()">Close</button>
      </div>`;
  },

  // Render a list of AI suggestion cards with accept/reject
  renderSuggestions(items, { onAccept, onReject, acceptLabel = 'Apply', showReject = true } = {}) {
    return items.map((item, i) => `
      <div class="ai-card" id="ai-card-${i}">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <div class="fw-bold small">${item.title || ''}</div>
          <div class="d-flex gap-1">
            <button class="ai-accept-btn" onclick="${onAccept ? onAccept.replace('INDEX', i) : ''}">
              <i class="bi bi-check2 me-1"></i>${acceptLabel}
            </button>
            ${showReject ? `<button class="ai-reject-btn" onclick="document.getElementById('ai-card-${i}').classList.add('rejected')">
              <i class="bi bi-x"></i>
            </button>` : ''}
          </div>
        </div>
        <div class="small text-muted">${item.description || ''}</div>
      </div>
    `).join('');
  }
};

document.addEventListener('DOMContentLoaded', () => AIPanel.init());
</script>
